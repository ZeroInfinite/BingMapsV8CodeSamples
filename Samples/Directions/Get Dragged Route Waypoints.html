<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <script type='text/javascript'>
        var map, directionsManager;

        function GetMap()
        {
            map = new Microsoft.Maps.Map('#myMap', {
                credentials: YourBingMapsKey
            });


            Microsoft.Maps.loadModule(['Microsoft.Maps.Directions'], function () {
                directionsManager = new Microsoft.Maps.Directions.DirectionsManager(map);

                //Create the initial route.
                directionsManager.addWaypoint(new Microsoft.Maps.Directions.Waypoint({ address: 'Seattle, WA' }));
                directionsManager.addWaypoint(new Microsoft.Maps.Directions.Waypoint({ address: 'Redmond, WA', isViaPoint: true }));
                directionsManager.addWaypoint(new Microsoft.Maps.Directions.Waypoint({ address: 'Bellevue, WA' }));

                //Add event handlers to directions manager.
                Microsoft.Maps.Events.addHandler(directionsManager, 'directionsUpdated', directionsUpdated);

                //Calculate directions.
                directionsManager.calculateDirections();
            });
        }

        function directionsUpdated(e) {
            map.entities.clear();

            var route = e.route[0];
            
            //Get the original waypoints used to calculate the route.
            var waypoints = directionsManager.getAllWaypoints();

            /*var waypoints = [];

            //Loop through the route and inspect the route legs that have more than one subLeg.
            //This will indicate that there is a via waypoint in that leg which has been dragged
            //since we haven't programmatically added any via waypoints.
            for (var i = 0, len = route.routeLegs.length; i < len; i++) {

                //The number of route legs should be equal to the number of original Waypoints minus 1.
                waypoints.push(originalWaypoints[i]);

                //Between each route leg may be a subLeg which is generated by a viaWaypoint. The last subLeg ends at a known waypoint.
                for (var j = 0, cnt = route.routeLegs[i].subLegs.length - 1; j < cnt; j++) {

                    //The end of the subLeg is the viaWaypoint. 
                    var viaLoc = route.routeLegs[i].subLegs[j].actualEnd;

                    //Add a red pushpin to the map to show where the viaWaypoint is.
                    map.entities.push(new Microsoft.Maps.Pushpin(viaLoc, { color: 'red' }));

                    //Create a via waypoint from the via location information. 
                    waypoints.push(new Microsoft.Maps.Directions.Waypoint({ location: viaLoc, isViaPoint: true }));
                }
            }

            //Add the final waypoint for the route.
            waypoints.push(originalWaypoints[originalWaypoints.length - 1]);*/

            //Display the waypoint information as a table.
            var html = ['<table><tr><td>Address</td><td>Location</td><td>IsViapoint</td></tr>'];



            for (var i = 0, len = waypoints.length; i < len; i++) {
                html.push('<tr><td>', waypoints[i].getAddress(), '</td><td>', waypoints[i].getLocation(), '</td><td>', waypoints[i].isViapoint(), '</td></tr>');
            }

            html.push('</table>');

            document.getElementById('output').innerHTML = html.join('');
        }
    </script>
    <script type='text/javascript' src='/BingMapsCredentials.js'></script>
    <script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&branch=experimental' async defer></script>
</head>
<body>
    <div id="myMap" style="position:relative;width:800px;height:600px;"></div><br/>
    <div id="output"></div>

    <fieldset style="width:600px;margin-top:10px;">
        <legend>Get Dragged Route Waypoints Sample</legend>
        The directions managers getAllWaypoints function retrieves all the waypoints that have been specified to the directions manager and not via waypoints which the route has been dragged to. 
        This sample shows how to capture all waypoints used to calculate a route, including dragged via waypoints. These can then be used later to regenerate a previous route.
    </fieldset>
</body>
</html>